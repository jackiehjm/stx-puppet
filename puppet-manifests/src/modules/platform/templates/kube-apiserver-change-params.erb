<%# Kubeadm stores the cluster configuration as a configmap in the cluster. -%>
<%# We will change that configmap to include/remove kube-apiserver parameters. -%>
<%# In order to restart kube-apiserver, we will use the "kubeadm init phase" -%>
<%# command and feed it the current ClusterConfiguration. This will keep the -%>
<%# configmap consistent and keeps kube-apiserver managed by kubeadm, but as a -%>
<%# side-effect, the kube-apiserver advertise address gets reset to the default -%>
<%# network interface. As a work around for that, we'll manually set it back -%>
<%# to its previous value. -%>
umask 077; touch <%= @configmap_temp_file %>
umask 077; touch <%= @configview_temp_file %>
kubectl --kubeconfig=/etc/kubernetes/admin.conf get configmap kubeadm-config -o yaml -n kube-system > <%= @configmap_temp_file %>
python /usr/share/puppet/modules/platform/files/change_kube_apiserver_params.py \
--configmap_file <%= @configmap_temp_file %> \
<%- if @oidc_issuer_url -%>
--oidc_issuer_url <%= @oidc_issuer_url %> \
<%- end -%>
<%- if @oidc_client_id -%>
--oidc_client_id <%= @oidc_client_id %> \
<%- end -%>
<%- if @oidc_username_claim -%>
--oidc_username_claim <%= @oidc_username_claim %> \
<%- end -%>
<%- if @oidc_groups_claim -%>
--oidc_groups_claim <%= @oidc_groups_claim %> \
<%- end -%>
<%- if @admission_plugins -%>
--admission_plugins <%= @admission_plugins %> \
<%- end -%>
<%- if @etcd_cafile -%>
--etcd_cafile <%= @etcd_cafile %> \
<%- end -%>
<%- if @etcd_certfile -%>
--etcd_certfile <%= @etcd_certfile %> \
<%- end -%>
<%- if @etcd_keyfile -%>
--etcd_keyfile <%= @etcd_keyfile %> \
<%- end -%>
<%- if @etcd_servers -%>
--etcd_servers <%= @etcd_servers %>
<%- end -%>
<%- if @audit_policy_file -%>
--audit_policy_file <%= @audit_policy_file %>
<%- end -%>

APISERVER_ADVERTISE_ADDRESS=$(grep 'advertise-address=' /etc/kubernetes/manifests/kube-apiserver.yaml  | cut -d "=" -f2)
kubectl --kubeconfig=/etc/kubernetes/admin.conf -n kube-system patch configmap kubeadm-config -p "$(cat <%= @configmap_temp_file %>)"
kubectl --kubeconfig=/etc/kubernetes/admin.conf get cm -n kube-system kubeadm-config -o=jsonpath='{.data.ClusterConfiguration}' > <%= @configmap_temp_file %>
kubeadm init phase control-plane apiserver --config <%= @configmap_temp_file %>
DEFAULT_NETWORK_INTERFACE=$(grep 'advertise-address=' /etc/kubernetes/manifests/kube-apiserver.yaml  | cut -d "=" -f2)
sed -i "/oidc-issuer-url/! s/$DEFAULT_NETWORK_INTERFACE/$APISERVER_ADVERTISE_ADDRESS/g" /etc/kubernetes/manifests/kube-apiserver.yaml
sed -i '/securityContext:/,/type: RuntimeDefault/d' /etc/kubernetes/manifests/kube-apiserver.yaml
rm <%= @configmap_temp_file %>
rm <%= @configview_temp_file %>
